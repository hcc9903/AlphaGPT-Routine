name: A-Stock AlphaGPT routine

on:
  workflow_dispatch:
    inputs:
      stock_code:
        description: 'ğŸ“ˆ è¯·è¾“å…¥6ä½è‚¡ç¥¨ä»£ç  (æ¯”å¦‚: 300912)'
        required: true
        default: '300912'
      my_formula:
        description: 'ğŸ§ª è¯·è¾“å…¥ä½ çš„é»„é‡‘å…¬å¼'
        required: true
        default: 'SUB(DIV(VOL_CHG, ABS(TREND)), TREND)'

jobs:
  analyze:
    runs-on: ubuntu-latest
    # æˆäºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿èƒ½æŠŠä¸¤èæ•°æ®ç¼“å­˜æ¨é€åˆ°ä»“åº“
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch pandas numpy akshare matplotlib pyarrow tqdm requests

      - name: Run analysis
        env:
          # æ ¸å¿ƒï¼šå°†ç½‘é¡µè¾“å…¥çš„ä¸­æ–‡å‚æ•°ä¼ ç»™ Python è„šæœ¬
          INDEX_CODE: ${{ github.event.inputs.stock_code }}
          BEST_FORMULA: ${{ github.event.inputs.my_formula }}
          FORCE_TRAIN: 'False'
          
          # å…¶ä»–åŸºç¡€é…ç½®
          START_DATE: '20220101'
          END_DATE: '20270101'
          BATCH_SIZE: 1024
          TRAIN_ITERATIONS: 100
          MAX_SEQ_LEN: 10
          COST_RATE: 0.0004
          LAST_NDAYS: 50
          HOLD_PERIOD: 11
          ONLY_LONG: 'True'
          
          # æ•æ„Ÿä¿¡æ¯é…ç½®
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: python times_astock.py

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¤èæ•°æ®æ›´æ–°ï¼Œæœ‰åˆ™æ¨é€å›ä»“åº“ä¿å­˜
          if [ -d "margin_balance" ]; then
            git add margin_balance/*.parquet
            git diff --quiet && git diff --staged --quiet || (git commit -m "Update margin data [skip ci]" && git push)
          fi
