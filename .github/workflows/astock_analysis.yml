name: A-Stock AlphaGPT routine

on:
  workflow_dispatch:
    inputs:
      stock_code:
        description: 'ğŸ“ˆ è¯·è¾“å…¥6ä½è‚¡ç¥¨ä»£ç '
        required: true
        default: '300912'
      run_mode:
        description: 'é€‰æ‹©æ¨¡å¼: æŒ–æ˜æ–°å…¬å¼ (Mine) / è¿è¡Œå·²æœ‰å…¬å¼ (Run)'
        required: true
        default: 'Run'  # é»˜è®¤è®¾ä¸ºè¿è¡Œæ¨¡å¼ï¼Œçœæ—¶é—´
        type: choice
        options:
          - Mine
          - Run
      my_formula:
        description: 'ğŸ§ª å¦‚æœé€‰Runï¼Œè¯·è¾“å…¥å…¬å¼ (é€‰Mineåˆ™ç•™ç©º)'
        required: false
        default: 'SUB(DIV(VOL_CHG, ABS(TREND)), TREND)'
      iterations:
        description: 'æŒ–æ˜æ·±åº¦ (ä»…åœ¨Mineæ¨¡å¼æœ‰æ•ˆ)'
        required: true
        default: '100'

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch pandas numpy akshare matplotlib pyarrow tqdm requests

      - name: Run analysis
        env:
          INDEX_CODE: ${{ github.event.inputs.stock_code }}
          # æ ¸å¿ƒåˆ¤å®šé€»è¾‘
          FORCE_TRAIN: ${{ github.event.inputs.run_mode == 'Mine' && 'True' || 'False' }}
          BEST_FORMULA: ${{ github.event.inputs.my_formula }}
          TRAIN_ITERATIONS: ${{ github.event.inputs.iterations }}
          
          START_DATE: '20220101'
          END_DATE: '20270101'
          BATCH_SIZE: 1024
          MAX_SEQ_LEN: 10
          COST_RATE: 0.0004
          LAST_NDAYS: 50
          HOLD_PERIOD: 11
          ONLY_LONG: 'True'
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: python times_astock.py

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add *.txt 2>/dev/null || true
          if [ -d "margin_balance" ]; then git add margin_balance/*.parquet; fi
          git diff --quiet && git diff --staged --quiet || (git commit -m "æ•°æ®æ›´æ–°: ${INDEX_CODE} [skip ci]" && git push)
